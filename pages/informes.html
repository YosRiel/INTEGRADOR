<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crear Informe</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body, html {
      height: 100%;
    }
    .sidebar {
      height: 100vh;
      background-color: #f1f3f5;
      border-right: 1px solid #dee2e6;
    }
    .content {
      padding: 20px;
      background-color: #ffffff;
      height: 100vh;
      overflow-y: auto;
    }
    .logo {
      width: 120px;
      margin: 20px auto;
      display: block;
    }
    .historial {
      padding: 0 15px;
    }
    .img-thumbnail {
      width: 100px;
      height: 100px;
      object-fit: cover;
    }
    .card {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row">

    <!-- Sidebar -->
    <div class="col-md-3 sidebar d-flex flex-column">
      <a href="main menu.html">
        <img src="../media/LOGO SH.png" alt="Logo" class="logo">
      </a>
      <h5 class="text-center mt-3">Historial de Informes</h5>
      <ul class="list-group historial" id="historialInformes"></ul>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 content">
      <h1 class="mb-4">Crear Nuevo Informe</h1>

      <div class="row">
        <!-- Formulario -->
        <div class="col-md-6">
          <div class="card p-4 mb-4">
            <div class="mb-3">
              <label for="informeNombre" class="form-label">Nombre del Informe</label>
              <input type="text" class="form-control" id="informeNombre" placeholder="SM-Nº INFORME-TIPO_DE_SERVICIO">
            </div>
            <button class="btn btn-primary w-100 mb-3" onclick="crearInforme()">Crear Informe</button>

            <div id="grupoSection" class="d-none">
              <h5>Agregar Grupo de Imágenes</h5>
              <div class="mb-3">
                <label for="grupoNombre" class="form-label">Nombre del Grupo</label>
                <input type="text" class="form-control" id="grupoNombre" placeholder="ANTES DEL SERVICIO">
              </div>
              <div class="mb-3">
                <label for="imagenesGrupo" class="form-label">Seleccionar Imágenes</label>
                <input type="file" class="form-control" id="imagenesGrupo" multiple accept="image/*">
              </div>
              <button class="btn btn-success w-100 mb-3" onclick="agregarGrupo()">Agregar Grupo</button>
            </div>

            <div id="guardarSection" class="d-none">
              <button class="btn btn-success btn-lg w-100" onclick="guardarInforme()">Guardar Informe</button>
            </div>
          </div>
        </div>

        <!-- Vista previa -->
        <div class="col-md-6">
          <h4>Vista Previa del Informe</h4>
          <div id="vistaPrevia"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
let informe = { nombre: '', grupos: [] };

function crearInforme() {
  const nombre = document.getElementById('informeNombre').value.trim();
  if (!nombre) return alert('Por favor ingresa un nombre para el informe.');
  informe = { nombre, grupos: [] };
  document.getElementById('grupoSection').classList.remove('d-none');
  document.getElementById('guardarSection').classList.remove('d-none');
  document.getElementById('vistaPrevia').innerHTML = '';
  alert('Informe creado. Ahora puedes agregar grupos de imágenes.');
}

function agregarGrupo() {
  const grupoNombre = document.getElementById('grupoNombre').value.trim();
  const imagenesInput = document.getElementById('imagenesGrupo');
  const imagenes = [];

  if (!grupoNombre) return alert('Por favor ingresa un nombre para el grupo.');
  if (imagenesInput.files.length === 0) return alert('Por favor selecciona al menos una imagen.');

  const archivos = Array.from(imagenesInput.files);
  let cargadas = 0;

  archivos.forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      imagenes.push(e.target.result);
      cargadas++;
      if (cargadas === archivos.length) {
        informe.grupos.push({ nombreGrupo: grupoNombre, imagenes });
        mostrarVistaPrevia();
        document.getElementById('grupoNombre').value = '';
        document.getElementById('imagenesGrupo').value = '';
      }
    };
    reader.readAsDataURL(file);
  });
}

function mostrarVistaPrevia() {
  const vista = document.getElementById('vistaPrevia');
  vista.innerHTML = '';
  informe.grupos.forEach((grupo, index) => {
    const grupoCard = document.createElement('div');
    grupoCard.className = 'card mb-3';
    grupoCard.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">${grupo.nombreGrupo}</h5>
          <button class="btn btn-sm btn-outline-primary" onclick="editarGrupo(${index})">✏️</button>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-3">
          ${grupo.imagenes.map(img => `<img src="${img}" class="img-thumbnail">`).join('')}
        </div>
      </div>`;
    vista.appendChild(grupoCard);
  });
}

function guardarInforme() {
  if (!informe.nombre || informe.grupos.length === 0) return alert('Debes crear un informe y agregar al menos un grupo.');
  let informes = JSON.parse(localStorage.getItem('informesGuardados')) || [];
  informes.push(informe);
  localStorage.setItem('informesGuardados', JSON.stringify(informes));
  alert('Informe guardado exitosamente.');
  informe = { nombre: '', grupos: [] };
  document.getElementById('informeNombre').value = '';
  document.getElementById('grupoSection').classList.add('d-none');
  document.getElementById('guardarSection').classList.add('d-none');
  document.getElementById('vistaPrevia').innerHTML = '';
  cargarHistorial();
}

function cargarHistorial() {
  const historial = document.getElementById('historialInformes');
  historial.innerHTML = '';
  const informes = JSON.parse(localStorage.getItem('informesGuardados')) || [];
  informes.forEach((informe, index) => {
    const item = document.createElement('li');
    item.className = 'list-group-item';
    item.textContent = informe.nombre;
    item.style.cursor = 'pointer';
    item.onclick = () => cargarInforme(index);
    historial.appendChild(item);
  });
}

function cargarInforme(index) {
  const informes = JSON.parse(localStorage.getItem('informesGuardados')) || [];
  const selectedInforme = informes[index];
  informe = selectedInforme;
  mostrarVistaPrevia();
  document.getElementById('grupoSection').classList.remove('d-none');
  document.getElementById('guardarSection').classList.remove('d-none');
  document.getElementById('informeNombre').value = selectedInforme.nombre;
  alert(`Informe "${selectedInforme.nombre}" cargado para edición.`);
}

function editarGrupo(index) {
  const nuevoNombre = prompt('Editar nombre del grupo:', informe.grupos[index].nombreGrupo);
  if (nuevoNombre !== null && nuevoNombre.trim() !== '') {
    informe.grupos[index].nombreGrupo = nuevoNombre.trim();
  }
  if (confirm('¿Quieres agregar más imágenes a este grupo?')) {
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = 'image/*';
    input.style.display = 'none';
    document.body.appendChild(input);
    input.addEventListener('change', function() {
      const archivos = Array.from(input.files);
      let cargadas = 0;
      archivos.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          informe.grupos[index].imagenes.push(e.target.result);
          cargadas++;
          if (cargadas === archivos.length) {
            mostrarVistaPrevia();
            document.body.removeChild(input);
          }
        };
        reader.readAsDataURL(file);
      });
    });
    input.click();
  } else {
    mostrarVistaPrevia();
  }
}

document.addEventListener('DOMContentLoaded', cargarHistorial);
</script>

</body>
</html>